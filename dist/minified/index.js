const EventEmitter=require("event-emitter-object/source"),scripter=require("dom-scripter/source"),kit=require("@basekits/core"),kitType=require("@basekits/kit-type"),kitObject=require("@basekits/kit-object");function Metapatcher(a={}){EventEmitter.call(this,a),this.structuredDataEnabled=!0,this.msTagsEnabled=!0,this.safariTagsEnabled=!0,this.appleTagsEnabled=!0,this.openGraphTagsEnabled=!0,this.twitterTagsEnabled=!0,this.facebookTagsEnabled=!0,this.sizeRe=/[0-9]{2,3}x[0-9]{2,3}/g,this.extTypeMap={svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",ico:"image/x-icon",gif:"image/gif",webp:"image/webp",bmp:"image/bmp"},this.setHTMLMetaTag("msapplication-config","none"),this.kit=kit,this.kit.addKit(kitType),this.kit.addKit(kitObject)}Metapatcher.prototype=Object.create(EventEmitter.prototype),Metapatcher.prototype.constructor=Metapatcher,Metapatcher.prototype.context={favicon:null,projectName:null,projectURL:null,projectLogo:null,primaryColor:null,bgColor:null,page:{title:null,url:null,image:null,breadcrumb:[]},robots:{},canonicals:{},localizedVersions:{},opengraph:{sitename:null,title:null,url:null,description:null,image:null,locale:null,localeAlternates:[]},structuredData:{name:null,url:null,logo:null,sameAs:[],contactPoints:[],breadcrumb:[]},androidChrome:{appIcons:[]},safari:{mobileWebApp:{title:null,statusBarStyle:null},pinnedTab:{url:null,color:null}},apple:{appIcons:[]},microsoft:{name:null,config:null,url:null,appIcons:[]},facebook:{},twitter:{},instagram:{},linkedin:{}},Metapatcher.prototype.setFavicon=function(a){if(!this.kit.isEmpty(a)&&this.kit.isString(a)){this.context.favicon=a;const b=a.slice(a.lastIndexOf(".")+1);this.setHTMLLinkTag("favicon-single","shortcut icon",a,{type:this.findIconTypeFromExtension(b)})}},Metapatcher.prototype.setProjectName=function(a){this.context.projectName=a,this.context.opengraph.sitename=a,this.context.microsoft.name=a,this.context.safari.mobileWebApp.title=a,this.msTagsEnabled&&this.setHTMLMetaTag("application-name",a),this.safariTagsEnabled&&(this.setHTMLMetaTag("apple-mobile-web-app-capable","yes"),this.setHTMLMetaTag("apple-mobile-web-app-title",a)),this.openGraphTagsEnabled&&this.setOGTag("og:site_name",a)},Metapatcher.prototype.setProjectURL=function(a){this.context.projectURL=a,this.context.microsoft.url=a,this.msTagsEnabled&&this.setHTMLMetaTag("msapplication-starturl",a)},Metapatcher.prototype.setProjectLogo=function(a){if(this.context.projectLogo=a,this.structuredDataEnabled){const b={"@type":"Organization",logo:a,url:this.context.projectURL};this.insertJSONLDObject(b,"metapatcher-sd-logo")}},Metapatcher.prototype.setPrimaryColor=function(a){this.context.primaryColor=a,this.setHTMLMetaTag("theme-color",a)},Metapatcher.prototype.setBGColor=function(a){this.context.bgColor=a,this.msTagsEnabled&&this.setHTMLMetaTag("msapplication-TileColor",a)},Metapatcher.prototype.preLoad=function(a,b,c={}){this.setHTMLLinkTag(a,"preload",b,c)},Metapatcher.prototype.preFetch=function(a,b,c={}){this.setHTMLLinkTag(a,"prefetch",b,c)},Metapatcher.prototype.preConnect=function(a,b,c={}){this.setHTMLLinkTag(a,"preconnect",b,c)},Metapatcher.prototype.dnsPreFetch=function(a,b,c={}){this.setHTMLLinkTag(a,"dns-prefetch",b,c)},Metapatcher.prototype.setWebAppManifest=function(a){this.setHTMLLinkTag("web-app-manifest","manifest",a)},Metapatcher.prototype.setViewport=function(a){this.setHTMLMetaTag("viewport",a)},Metapatcher.prototype.disableChromeAutoTranslateRecommendation=function(){this.setHTMLMetaTag("google","notranslate")},Metapatcher.prototype.setRobotTag=function(a,b){this.context.robots[a]=b,this.setHTMLMetaTag(a,b)},Metapatcher.prototype.noindex=function(){this.setRobotTag("robots","noindex")},Metapatcher.prototype.setAndroidChromeIcons=function(a){const b=this,c=["72x72","96x96","128x128","144x144","152x152","192x192","384x384","512x512"],d=Object.values(b.extTypeMap),e=a.map(function(a){const c={src:null,sizes:null,type:null};if(b.kit.isObject(a)?(c.src=b.kit.getProp(a,"src",null),c.sizes=b.kit.getProp(a,"sizes",null),c.type=b.kit.getProp(a,"type",null)):b.kit.isString(a)&&(c.src=a),b.kit.isEmpty(c.sizes)){const a=c.src.match(b.sizeRe);a&&0<a.length&&(c.sizes=a[0])}if(b.kit.isEmpty(c.type)){const a=c.src.slice(c.src.lastIndexOf(".")+1);c.type=b.findIconTypeFromExtension(a)}return c}).filter(function(a){if(b.kit.isEmpty(a.src)||b.kit.isEmpty(a.type)||b.kit.isEmpty(a.sizes))return!1;const e=a.src.match(b.sizeRe);return!b.kit.isEmpty(e)&&-1!==c.indexOf(a.sizes)&&-1!==d.indexOf(a.type)});0===e.length||(b.context.androidChrome.appIcons=e,e.map(function(a){const c="android-chrome-icon-"+a.sizes;b.setHTMLLinkTag(c,"icon",a.src,{sizes:a.sizes,type:a.type})}))},Metapatcher.prototype.setSafariMobileWebApp=function(a,b){this.safariTagsEnabled&&(this.context.safari.mobileWebApp.title=a,this.context.safari.mobileWebApp.statusBarStyle=b,this.setHTMLMetaTag("apple-mobile-web-app-capable","yes"),this.setHTMLMetaTag("apple-mobile-web-app-title",a),this.setHTMLMetaTag("apple-mobile-web-app-status-bar-style",b))},Metapatcher.prototype.setAppleTouchIcons=function(a){const b=this,c=["120x120","180x180","152x152","167x167","1024x1024"],d=Object.values(b.extTypeMap),e=a.map(function(a){const c={src:null,sizes:null,type:null};if(b.kit.isObject(a)?(c.src=b.kit.getProp(a,"src",null),c.sizes=b.kit.getProp(a,"sizes",null),c.type=b.kit.getProp(a,"type",null)):b.kit.isString(a)&&(c.src=a),b.kit.isEmpty(c.sizes)){const a=c.src.match(b.sizeRe);a&&0<a.length&&(c.sizes=a[0])}if(b.kit.isEmpty(c.type)){const a=c.src.slice(c.src.lastIndexOf(".")+1);c.type=b.findIconTypeFromExtension(a)}return c}).filter(function(a){if(b.kit.isEmpty(a.src)||b.kit.isEmpty(a.type)||b.kit.isEmpty(a.sizes))return!1;const e=a.src.match(b.sizeRe);return!b.kit.isEmpty(e)&&-1!==c.indexOf(a.sizes)&&-1!==d.indexOf(a.type)});0!==e.length&&(this.context.apple.appIcons=e,b.appleTagsEnabled&&e.map(function(a){const c="apple-touch-icon-"+a.sizes;b.setHTMLLinkTag(c,"apple-touch-icon",a.src,{sizes:a.sizes})}))},Metapatcher.prototype.setSafariPinnedTab=function(a,b=null){const d=b||this.context.primaryColor;if(this.context.safari.pinnedTab.url=a,this.context.safari.pinnedTab.color=d,this.safariTagsEnabled){this.setHTMLLinkTag("safari-pinned-tab","mast-icon",a,{color:d})}},Metapatcher.prototype.setMSAppConfig=function(a){!this.kit.isEmpty(a)&&this.kit.isString(a)&&(this.context.microsoft.config=a,this.msTagsEnabled&&this.setHTMLMetaTag("msapplication-config",a))},Metapatcher.prototype.setMSTileIcons=function(a){const b=this,c={"70x70":"msapplication-square70x70logo","150x150":"msapplication-square150x150logo","310x310":"msapplication-square310x310logo","310x150":"msapplication-wide310x150logo"},d=["70x70","150x150","310x150","310x310"],e=Object.values(b.extTypeMap),f=a.map(function(a){const c={src:null,sizes:null,type:null,name:null};if(b.kit.isObject(a)?(c.src=b.kit.getProp(a,"src",null),c.sizes=b.kit.getProp(a,"sizes",null),c.type=b.kit.getProp(a,"type",null)):b.kit.isString(a)&&(c.src=a),b.kit.isEmpty(c.sizes)){const a=c.src.match(b.sizeRe);a&&0<a.length&&(c.sizes=a[0])}if(b.kit.isEmpty(c.type)){const a=c.src.slice(c.src.lastIndexOf(".")+1);c.type=b.findIconTypeFromExtension(a)}return c}).filter(function(a){if(b.kit.isEmpty(a.src)||b.kit.isEmpty(a.type)||b.kit.isEmpty(a.sizes))return!1;const c=a.src.match(b.sizeRe);return!b.kit.isEmpty(c)&&-1!==d.indexOf(a.sizes)&&-1!==e.indexOf(a.type)}).map(function(a){return a.name=c[a.sizes],a});0!==f.length&&(b.context.microsoft.appIcons=f,b.msTagsEnabled&&f.map(function(a){b.setHTMLMetaTag(a.name,a.src)}))},Metapatcher.prototype.insertCanonical=function(a,b){this.context.canonicals[a]=b,this.setHTMLLinkTag(a,b)},Metapatcher.prototype.removeCanonical=function(a){this.context.canonicals.hasOwnProperty(a)&&delete this.context.canonicals[a],this.removeHTMLLinkTag(a)},Metapatcher.prototype.removeAllCanonicals=function(){const a=this;Object.keys(a.context.canonicals).map(b=>a.removeHTMLLinkTag(b)),a.context.canonicals={}},Metapatcher.prototype.insertLocalizedVersion=function(a,b,c){const d="alternate-locale-"+a.toLowerCase();this.context.localizedVersions[d]=b,this.setHTMLLinkTag(d,"alternate",b,{hreflang:a}),this.openGraphTagsEnabled&&(a==c?(this.context.opengraph.locale=a,this.setOGTag("og:locale",a.replace("-","_"))):(this.context.opengraph.localeAlternates.push(a),this.setOGTag("og:locale:alternate",a.replace("-","_"))))},Metapatcher.prototype.removeLocalizedVersion=function(a){const b="alternate-locale-"+a.toLowerCase();if(this.context.localizedVersions.hasOwnProperty(b)&&delete this.context.localizedVersions[b],this.removeHTMLLinkTag(b),this.openGraphTagsEnabled){this.context.opengraph.locale==a&&(this.context.opengraph.locale=null,this.removeOGTag("og:locale",a.replace("-","_")));const b=this.context.opengraph.localeAlternates;-1!==b.indexOf(a)&&(this.context.opengraph.localeAlternates=b.filter(b=>b!=a),this.removeOGTag("og:locale:alternate",a.replace("-","_")))}},Metapatcher.prototype.removeAllLocalizedVersions=function(){const a=this;Object.keys(a.context.localizedVersions).map(b=>a.removeHTMLLinkTag(b)),a.context.localizedVersions={}},Metapatcher.prototype.setTitle=function(a){this.context.page.title=a,document.title=a},Metapatcher.prototype.setFacebookProfile=function(a){if(this.context.facebook=a,this.facebookTagsEnabled){const b=this.kit.getProp(a,["app","id"]);this.kit.isEmpty(b)||this.setOGTag("fb:app_id",b)}},Metapatcher.prototype.setTwitterProfile=function(a){if(this.context.twitter=a,this.twitterTagsEnabled){const b=this.kit.getProp(a,["card"]);b&&this.setHTMLMetaTag("twitter:card",b);const c=this.kit.getProp(a,["site"]);c&&this.setHTMLMetaTag("twitter:site",c);const d=this.kit.getProp(a,["creator"]);d&&this.setHTMLMetaTag("twitter:creator",d)}},Metapatcher.prototype.setPageMetadata=function(a){if(a.title&&(this.setTitle(a.title),this.openGraphTagsEnabled&&this.setOGTag("og:title",a.title),this.twitterTagsEnabled&&this.setHTMLMetaTag("twitter:title",a.title)),a.url&&(this.context.page.url=a.url,this.context.opengraph.url=a.url,this.openGraphTagsEnabled&&this.setOGTag("og:url",a.url)),a.description&&(this.context.page.description=a.description,this.context.opengraph.description=a.description,this.setHTMLMetaTag("description",a.description),this.openGraphTagsEnabled&&this.setOGTag("og:description",a.description),this.twitterTagsEnabled&&this.setHTMLMetaTag("twitter:description",a.description)),a.image){const b={url:null,width:null,height:null};"string"==typeof a.image&&(b.url=a.image),"[object Object]"===Object.prototype.toString.call(a.image)&&(b.url=a.image.url,a.image.width&&(b.width=a.image.width),a.image.height&&(b.height=a.image.height)),this.context.page.image=b,this.context.opengraph.image=b,this.openGraphTagsEnabled&&(this.setOGTag("og:image",b.url),b.width&&this.setOGTag("og:image:width",b.width),b.height&&this.setOGTag("og:image:height",b.height)),this.twitterTagsEnabled&&this.setHTMLMetaTag("twitter:image",b.url)}if(a.locale&&(this.context.page.locale=a.locale,this.context.opengraph.locale=a.locale,document.querySelector("html").setAttribute("lang",a.locale),this.openGraphTagsEnabled)){const b=a.locale.replace("-","_");this.context.opengraph.locale=b,this.setOGTag("og:locale",b)}},Metapatcher.prototype.breadcrumb=function(a){this.context.page.breadcrumb=a,this.structuredDataEnabled&&(this.context.structuredData.breadcrumb={"@type":"BreadcrumbList",itemListElement:a.map(function(a,b){return{"@type":"ListItem",position:b+1,name:a.title,item:a.url}})},this.insertJSONLDObject(this.context.structuredData.breadcrumb,"metapatcher-breadcrumb"))},Metapatcher.prototype.setOGTag=function(a,b){let c=document.querySelector("meta[property=\""+a+"\"]");c?c.getAttribute("content")!=b&&c.setAttribute("content",b):(c=document.createElement("meta"),c.setAttribute("property",a),c.setAttribute("content",b),document.getElementsByTagName("head")[0].appendChild(c))},Metapatcher.prototype.removeOGTag=function(a,b){const c=document.querySelector("meta[property=\""+a+"\"][content=\""+b+"\"]");c&&c.parentNode.removeChild(c)},Metapatcher.prototype.setHTMLLinkTag=function(a,b,c,d={}){const e=Object.assign({},{id:a,rel:b,href:c},d||{});let f=document.querySelector("link[id=\""+a+"\"]");f||(f=document.createElement("link"),document.getElementsByTagName("head")[0].appendChild(f)),Object.keys(e).map(a=>f.setAttribute(a,e[a]))},Metapatcher.prototype.removeHTMLLinkTag=function(a){const b=document.querySelector("link[id=\""+a+"\"]");b&&b.parentNode.removeChild(b)},Metapatcher.prototype.setHTMLMetaTag=function(a,b){let c=document.querySelector("meta[name=\""+a+"\"]");c?c.getAttribute("content")!=b&&c.setAttribute("content",b):(c=document.createElement("meta"),c.setAttribute("name",a),c.setAttribute("content",b),document.getElementsByTagName("head")[0].appendChild(c))},Metapatcher.prototype.insertJSONLDObject=function(a,b=null){scripter.injectJSONLD(a,{id:b})},Metapatcher.prototype.findIconTypeFromExtension=function(a){return this.extTypeMap.hasOwnProperty(a)?this.extTypeMap[a]:void 0},Metapatcher.prototype.disableStructuredData=function(){this.structuredDataEnabled=!1},Metapatcher.prototype.disableMSTags=function(){this.msTagsEnabled=!1;const a=document.querySelector("meta[name=\"msapplication-config\"]");a&&a.parentNode.removeChild(a)},Metapatcher.prototype.disableSafariTags=function(){this.safariTagsEnabled=!1},Metapatcher.prototype.disableAppleTags=function(){this.appleTagsEnabled=!1},Metapatcher.prototype.disableOpenGraphTags=function(){this.openGraphTagsEnabled=!1},Metapatcher.prototype.disableTwitterTags=function(){this.twitterTagsEnabled=!1},Metapatcher.prototype.disableFacebookTags=function(){this.facebookTagsEnabled=!1},module.exports=Metapatcher;